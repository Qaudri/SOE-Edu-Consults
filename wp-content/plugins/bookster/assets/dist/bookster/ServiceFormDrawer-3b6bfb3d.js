import{c as e,R as t,_ as r,r as a,b as s,L as n,a as i,d as o}from"./prefetch.helper-04349684.js";import{u as c}from"./store-bdc614dc.js";import{k as l}from"./CoverPicker-52693ec5.js";import{S as u,A as m}from"./ServiceCard-1f94e7ea.js";import{S as d,P as v}from"./queue.helper-cc60359e.js";import{P as b}from"./UIComponents-7ff4460b.js";import{r as g}from"./react-dom-3e43fe1d.js";import{u as w}from"./BEConfigProvider-705eafe2.js";import{u as y}from"./useServiceFormContext-43091331.js";async function f(t){return await e.api.post("services_categories",{json:t}).json()}async function _(t){return await e.api.delete(`services_categories/${t}`).json()}function p({children:a,cate:s}){var n;const i=e.useAllServices(),o=c((e=>e.closeServiceNestedCategory)),[l]=c((e=>e.services.form.nestedCategory)),u=isNaN(Number(l))?null:Number(l),m=!i,d=0===(null==(n=null==i?void 0:i.find((e=>e.service_category_id===s.service_category_id)))?void 0:n.services.length),v=e.useMutation({mutationKey:["serviceCategories",u,"delete"],mutationFn:_,onSuccess:()=>{e.queryClient.removeQueries({queryKey:["serviceCategory",u]}),e.queryClient.invalidateQueries({queryKey:["services"]})}}),b=v.isLoading||m||!d;return t.createElement(r.DropdownMenuItem,{className:"bw-flex bw-cursor-pointer bw-items-center",onClick:async()=>{b||await async function(){if(s)try{await v.mutateAsync(s.service_category_id),r.toast.success("Category has been Deleted Successfully!"),o()}catch(t){r.toast.error(await e.getErrorMsg(t))}}()},disabled:b},a)}function E({service:s,className:n,...i}){const{setNodeRef:o,attributes:c,listeners:l,transition:u,transform:d,isDragging:v}=e.useSortable({id:`service-${s.service_id}`,data:{type:"service",service:s}}),b={transition:u,transform:e.dndCSS.Transform.toString(d)},g=e.useQueryClient(),y=w(),f=a.useCallback((e=>{e.stopPropagation(),y(`${s.service_id}`),g.setQueryData(["service",s.service_id],s)}),[s]),_=a.useMemo((()=>t.createElement(m,{service:s})),[s]);return v?t.createElement("div",{ref:o,className:"bw-cursor-grab bw-rounded-sm bw-bg-gray-20",style:b},t.createElement(C,{className:"bw-opacity-0",service:s,serviceDescription:_})):t.createElement("div",{className:r.cx("bw-cursor-grab bw-rounded-sm bw-bg-white",n),style:b,ref:o,...c,...l,...i},t.createElement(C,{service:s,serviceDescription:_,onClick:f}))}const C=a.memo(u);function x({cate:o,className:l,...u}){const m=c((e=>e.editServiceNestedCategory)),d=c((e=>e.initServiceForm)),[v,b]=a.useState(500),g=e.useQueryClient(),y=w(),f=a.useRef(null);a.useEffect((()=>{f.current&&b(f.current.clientHeight)}),[o.services.length]);const _=a.useMemo((()=>o.services.map((e=>`service-${e.service_id}`))),[o.services]),{setNodeRef:C,attributes:x,listeners:h,transition:N,transform:S,isDragging:D}=e.useSortable({id:`cate-${o.service_category_id}`,data:{type:"cate",cate:o}}),k={transition:N,transform:e.dndCSS.Transform.toString(S)};return D?t.createElement("div",{ref:C,style:k,className:"bw-flex bw-h-full bw-w-72"},t.createElement("div",{className:"bw-w-full bw-rounded bw-bg-gray-100",style:{height:v}})):t.createElement("div",{ref:C,className:"bw-h-full"},t.createElement("div",{ref:f,style:k,className:r.cx("bw-flex bw-h-full bw-w-72 bw-flex-col bw-rounded-md bw-bg-white bw-shadow-sm",l),...u},t.createElement("div",{className:"bw-flex bw-flex-none bw-items-center bw-gap-2.5 bw-border-0 bw-border-b bw-border-solid bw-px-4 bw-py-3 bw-text-lg"},t.createElement("div",{className:"bw-flex bw-flex-1 bw-cursor-grab bw-items-center bw-gap-2.5",...x,...h},t.createElement("h3",{className:"bw-text-base"},o.name)),t.createElement(r.Tooltip,{content:s.sprintf(s.__("Add new %(service)s","bookster"),n)},t.createElement(r.Button,{variant:"fill",size:"icon",color:"primary",className:"bw-h-6 bw-w-6 bw-rounded-[5px] bw-bg-info/10 bw-text-primary hover:bw-bg-info hover:bw-text-white focus:bw-bg-info focus:bw-text-white active:bw-bg-info active:bw-text-white",onClick:e=>{var t;e.stopPropagation(),t=o.service_category_id,d({service_category_id:t}),y("new")}},t.createElement(i.Plus,{strokeWidth:"2",className:"bw-h-2.5 bw-w-2.5"}))),t.createElement(r.DropdownMenu,null,t.createElement(r.DropdownMenuTrigger,{asChild:!0},t.createElement(r.Button,{variant:"ghost",size:"icon",className:"bw-h-6 bw-w-6 bw-rounded-[5px] bw-bg-gray-20 bw-text-gray-500 hover:bw-bg-info/10 hover:bw-text-primary focus:bw-bg-info/10 focus:bw-text-primary active:bw-bg-info/10 active:bw-text-primary"},t.createElement(i.EllipsisVertical,null))),t.createElement(r.DropdownMenuContent,{align:"end"},t.createElement(r.DropdownMenuLabel,null,s.__("More Actions","bookster")),t.createElement(r.DropdownMenuSeparator,null),t.createElement(r.DropdownMenuGroup,{className:"bw-space-y-1.5 bw-p-1.5"},t.createElement(r.DropdownMenuItem,{onClick:e=>{e.stopPropagation(),g.setQueryData(["serviceCategory",o.service_category_id],o),m(o.service_category_id)}},t.createElement(i.Pen,null),t.createElement("span",{className:"bw-ml-2"},s.__("Edit category","bookster"))),t.createElement(p,{cate:o},t.createElement(i.Trash,null),t.createElement("span",{className:"bw-ml-2"},s.__("Delete category","bookster"))))))),t.createElement("div",{className:"btr-scrollbar-sm bw-flex bw-flex-grow bw-flex-col bw-gap-4 bw-overflow-y-auto bw-px-2.5 bw-py-3",style:{scrollbarGutter:"stable both-edges"}},t.createElement(e.SortableContext,{items:_},o.services.map((e=>t.createElement(E,{key:e.service_id,service:e})))))))}function h(e,t,r,a,s){const n=[...e];if(t===a){if(r===s)return e;const a={...n[t]},i=[...n[t].services],o=i.splice(r,1);return i.splice(s,0,...o),a.services=i,n[t]=a,n}const i={...n[t]},o={...n[a]},c=o.service_category_id,l=[...i.services],u=[...o.services],m=l.splice(r,1).map((e=>({...e,service_category_id:c})));return u.splice(s,0,...m),i.services=l,o.services=u,n[t]=i,n[a]=o,n}const N=new v,S="service",D="cate";function k(){const o=e.useQueryClient(),v=c((e=>e.newServiceNestedCategory)),{data:w,isLoading:y}=e.useAllServicesQuery(),f=void 0===w?[]:w,{toast:_}=r.useToast(),[p,E]=a.useState(void 0),[C,k]=a.useState(void 0),[F,I]=a.useState(null),M=e.useSensors(e.useSensor(e.PointerSensor,{activationConstraint:{distance:5}})),{setNodeRef:j,attributes:Q,listeners:P}=e.useSortable({id:`service-${null==C?void 0:C.service_id}`,data:{type:"service",service:C}});function K(e){o.setQueryData(["services","group_by_category"],e)}const T=a.useMemo((()=>f?f.map((e=>`cate-${e.service_category_id}`)):[]),[f]);return t.createElement(t.Fragment,null,t.createElement(b.Wrapper,{className:"bw-my-4 bw-px-6"},t.createElement(b.Title,{className:"bw-flex bw-items-center"},n.services,t.createElement(d,{isSaving:F}))),t.createElement("div",{className:"btr-scrollbar-md bw-flex-grow bw-overflow-x-auto bw-px-5 bw-pb-4"},t.createElement("div",{className:"bw-flex bw-h-full bw-w-fit bw-flex-nowrap bw-items-start bw-gap-3"},t.createElement(e.DndContext,{sensors:M,onDragStart:function(e){var t,r;(null==(t=e.active.data.current)?void 0:t.type)!==D?(null==(r=e.active.data.current)?void 0:r.type)!==S||k(e.active.data.current.service):E(e.active.data.current.cate)},onDragEnd:function(t){var r,a,s,n,i,c;const{active:u}=t,m=null==(r=u.data.current)?void 0:r.type;if(m===S){const t=null==(a=u.data.current)?void 0:a.service.service_category_id,r=f.findIndex((e=>e.service_category_id===t)),i=null==(s=u.data.current)?void 0:s.service.service_id;let c=f[r].services.findIndex((e=>e.service_id===i));c++;const m=null==(n=u.data.current)?void 0:n.service.position;(null==C?void 0:C.service_category_id)===t&&m===c||async function(t,r,a){N.add((async()=>{try{I(!0),await l(t,r,a)}catch(s){throw I(null),_.error(await e.getErrorMsg(s)),s}}),(()=>{I(!1),o.invalidateQueries(["services","group_by_category"])}))}(i,t,c)}if(m===D){const t=null==(i=u.data.current)?void 0:i.cate.service_category_id;let r=f.findIndex((e=>e.service_category_id===t));r++,(null==(c=u.data.current)?void 0:c.cate.position)!==r&&async function(t,r){N.add((async()=>{try{I(!0),await async function(t,r){return await e.api.patch(`services_categories/${t}/update_position`,{json:{position:r}}).json()}(t,r)}catch(a){throw I(null),_.error(await e.getErrorMsg(a)),a}}),(()=>{I(!1),o.invalidateQueries(["services","group_by_category"])}))}(t,r)}E(void 0),k(void 0)},onDragOver:function(e){var t,r,a,s,n,i,o,c,l,u;const{active:m,over:d}=e;if(!d)return;const v=null==(t=m.data.current)?void 0:t.type,b=null==(r=d.data.current)?void 0:r.type;if(f){if(v===S){const e=null==(a=m.data.current)?void 0:a.service.service_category_id,t=f.findIndex((t=>t.service_category_id===e)),r=null==(s=m.data.current)?void 0:s.service.service_id,c=f[t].services.findIndex((e=>e.service_id===r));if(b===S){const e=null==(n=d.data.current)?void 0:n.service.service_category_id,a=f.findIndex((t=>t.service_category_id===e)),s=null==(i=d.data.current)?void 0:i.service.service_id,o=f[a].services.findIndex((e=>e.service_id===s));if(r===s)return f;K(h(f,t,c,a,o))}if(b===D){const r=null==(o=d.data.current)?void 0:o.cate.service_category_id;if(e===r)return f;const a=f.findIndex((e=>e.service_category_id===r));return void K(h(f,t,c,a,0))}}if(v===D){const e=null==(c=m.data.current)?void 0:c.cate.service_category_id,t=f.findIndex((t=>t.service_category_id===e)),r=b===S?null==(l=d.data.current)?void 0:l.service.service_category_id:null==(u=d.data.current)?void 0:u.cate.service_category_id,a=f.findIndex((e=>e.service_category_id===r));K(function(e,t,r){if(t===r)return e;const a=[...e],s=a.splice(t,1);return a.splice(r,0,...s),a}(f,t,a))}}}},t.createElement(e.SortableContext,{items:T},f&&f.map((e=>t.createElement(x,{key:e.service_category_id,cate:e})))),g.createPortal(t.createElement(e.DragOverlay,{className:"bookster-root"},p&&t.createElement(x,{className:"bw-rotate-3 bw-shadow-[0_25px_55px_0_rgb(0_0_0_/_0.3)]",cate:p}),C&&t.createElement(u,{service:C,className:"bw-rotate-[-1.38deg] bw-cursor-grab bw-rounded-sm bw-bg-white bw-shadow-[0_25px_55px_0_rgb(0_0_0_/_0.3)]","data-overlay":"true",serviceDescription:t.createElement(m,{service:C}),ref:j,...Q,...P})),document.body)),!y&&t.createElement("div",{className:"bw-flex bw-w-72 bw-cursor-pointer bw-items-center bw-justify-center bw-gap-2 bw-rounded-md bw-bg-primary-50 bw-px-4 bw-py-3 bw-text-gray-900 bw-transition-all bw-duration-300 hover:bw-text-info",onClick:()=>v()},t.createElement(i.Plus,null),t.createElement("span",{className:"bw-text-sm"},s.__("New Category","bookster"))))))}function F(){return t.createElement(t.Fragment,null,t.createElement(o.Form.Item,{name:"name",label:s.__("Category Name","bookster"),rules:[{required:!0}]},t.createElement(r.Input,{placeholder:s.__("Please enter category name","bookster"),autoFocus:!0})),t.createElement(o.Form.Item,{name:"description",label:s.__("Category Description","bookster")},t.createElement(r.Textarea,{rows:4,maxLength:150,placeholder:s.__("Please enter category description","bookster")})))}function I(){const[e]=o.Form.useForm();return t.createElement(t.Fragment,null,t.createElement(r.DialogTitle,null,s.__("Closing","bookster")),t.createElement(r.DialogCloseIcon,null),t.createElement(o.Form,{form:e,disabled:!0,layout:"vertical"},t.createElement(F,null)),t.createElement(r.DialogFooter,null,t.createElement(r.DialogClose,{asChild:!0},t.createElement(r.Button,{key:"back",tabIndex:-1,variant:"trivial"},s.__("Cancel","bookster"))),t.createElement(r.Button,{key:"submit"},s.__("Save","bookster"))))}function M(){const i=c((e=>e.closeServiceNestedCategory)),[,l]=c((e=>e.services.form.nestedCategory)),u=isNaN(Number(l))?null:Number(l),{data:m,isLoading:d}=function(t){return e.useQuery({queryKey:["serviceCategory",t],queryFn:()=>t?async function(t){return await e.api.get(`services_categories/${t}`).json()}(t):null,staleTime:0})}(u),{toast:v}=r.useToast(),[b]=o.Form.useForm(),g=e.useQueryClient(),w=e.useMutation({mutationKey:["serviceCategories",u,"edit"],mutationFn:({id:t,values:r})=>async function(t,r){return await e.api.patch(`services_categories/${t}`,{json:r}).json()}(t,r),onSuccess:e=>{g.setQueryData(["serviceCategory",e.service_category_id],e),g.invalidateQueries({queryKey:["services"]})}});a.useEffect((()=>{m&&(b.resetFields(),b.setFieldsValue(m))}),[m]);const y=!m&&!d,f=e.useIsMutating({mutationKey:["serviceCategories"]})>0,_=e.useIsMutating({mutationKey:["services"]})>0,p=d||y||f||_;return t.createElement(t.Fragment,null,t.createElement(r.DialogCloseIcon,null),t.createElement(r.DialogHeader,null,t.createElement(r.DialogTitle,null,s.sprintf(s.__("Edit %(service)s Category","bookster"),n))),t.createElement(r.LoadingOverlay,{loading:p}),t.createElement(r.DialogBody,null,t.createElement(o.Form,{form:b,name:"category-form",disabled:p,layout:"vertical",onFinish:t=>{!async function(t){if(u&&m)try{await w.mutateAsync({id:m.service_category_id,values:t}),v.success("Category has been Saved Successfully!"),i()}catch(r){v.error(await e.getErrorMsg(r))}}(t)}},t.createElement(F,null))),t.createElement(r.DialogFooter,null,t.createElement(r.DialogClose,{asChild:!0},t.createElement(r.Button,{key:"back",tabIndex:-1,variant:"soft",size:"large",className:"bw-min-w-[6rem]"},s.__("Cancel","bookster"))),t.createElement(r.Button,{key:"submit",type:"submit",disabled:p,size:"large",form:"category-form",className:"bw-min-w-[6rem]"},s.__("Save","bookster"))))}function j(){const a=c((e=>e.closeServiceNestedCategory)),{toast:i}=r.useToast(),{form:l}=y(),[u]=o.Form.useForm(),m=e.useQueryClient(),d=e.useMutation({mutationKey:["serviceCategories","new"],mutationFn:f,onSuccess:e=>{m.setQueryData(["serviceCategory",e.service_category_id],e),m.invalidateQueries({queryKey:["services"]})}}),v=Q;return t.createElement(t.Fragment,null,t.createElement(r.DialogCloseIcon,null),t.createElement(r.DialogHeader,null,t.createElement(r.DialogTitle,null,s.sprintf(s.__("New %(service)s Category","bookster"),n))),t.createElement(r.LoadingOverlay,{loading:d.isLoading}),t.createElement(r.DialogBody,null,t.createElement(o.Form,{form:u,name:"category-form",initialValues:v,disabled:d.isLoading,layout:"vertical",onFinish:t=>{!async function(t){try{const e=await d.mutateAsync(t);i.success("Category has been Saved Successfully!"),a(),l.setFieldsValue({service_category_id:e.service_category_id})}catch(r){i.error(await e.getErrorMsg(r))}}(t)}},t.createElement(F,null))),t.createElement(r.DialogFooter,null,t.createElement(r.DialogClose,{asChild:!0},t.createElement(r.Button,{key:"back",tabIndex:-1,variant:"soft",size:"large",className:"bw-min-w-[6rem]"},s.__("Cancel","bookster"))),t.createElement(r.Button,{key:"submit",type:"submit",size:"large",form:"category-form",className:"bw-min-w-[6rem]",disabled:d.isLoading},s.__("Save","bookster"))))}const Q={name:"",description:""};function P(){const[a]=c((e=>e.services.form.nestedCategory)),s=c((e=>e.closeServiceNestedCategory)),n=e.useIsMutating({mutationKey:["serviceCategories"]});return t.createElement(r.Dialog,{open:"close"!==a,onOpenChange:e=>{e||n||s()}},t.createElement(r.DialogPortalContent,null,"close"===a&&t.createElement(I,null),"new"===a&&t.createElement(j,null),"edit"===a&&t.createElement(M,null)))}function K({children:a}){const s=e.useMatch("/services/list"),n=w(),i=c((e=>e.resetServiceForm)),o=null===s,l=e.useIsMutating({mutationKey:["services"]});return t.createElement(r.Drawer,{open:o,onOpenChange:e=>{e||l||(n("."),i())}},t.createElement(r.DrawerPortalContent,null,a))}export{k as K,P as N,K as S};
