var d=booksterModules.utils;const et={selectService:"selectService",selectAgent:"selectAgent",selectDateTime:"selectDateTime",formContact:"formContact",selectPayOption:"selectPayOption",showAppointment:"showAppointment"};var m=React;const R=m.createContext(null);function S(){const t=m.useContext(R);if(!t)throw new Error("BookingConfigContext.Provider is missing!");return t}const ot=t=>d.createStore()(d.immer(()=>t)),A=m.createContext(void 0);function O(){const t=m.useContext(A);if(!t)throw new Error("BookingStoreContext.Provider is missing!");return t}function F(t,e){const o=O();return d.useStore(o,t,e)}function nt(t,e){const o=e.process.steps[t.process.current.stepIndex],n=o.phase,a=o.acts[t.process.current.actIndex];if(t.process.current.actIndex===0){const f=e.process.steps[t.process.current.stepIndex-1];t.process.current.stepIndex-=1,t.process.current.actIndex=f.acts.length-1}else t.process.current.actIndex-=1;const{stepIndex:i,actIndex:u}=t.process.current,r=e.process.steps[i],c=r.phase,b=r.acts[u];return{oldStep:o,oldPhase:n,oldActName:a,newStep:r,newPhase:c,newActName:b}}function st(t,e){const o=e.process.steps[t.process.current.stepIndex],n=o.phase,a=o.acts[t.process.current.actIndex];t.process.current.actIndex>=o.acts.length-1?(t.process.current.stepIndex+=1,t.process.current.actIndex=0):t.process.current.actIndex+=1;const{stepIndex:i,actIndex:u}=t.process.current,r=e.process.steps[i],c=r.phase,b=r.acts[u];return{oldStep:o,oldPhase:n,oldActName:a,newStep:r,newPhase:c,newActName:b}}const I=m.createContext(null);function y(){const t=m.useContext(I);if(!t)throw new Error("BookingLogicContext.Provider is missing!");return t}const N=m.createContext(null);function V(){const t=m.useContext(N);if(!t)throw new Error("BookingPartsContext.Provider is missing!");return t}const P=m.createContext({formLayout:"mobile",showSidebar:!1,showSummary:!1});function h(){return m.useContext(P)}var l=booksterModules.components,E=booksterModules.icons;function M(){const{context:t}=S();return t.parent.is==="dialog"?React.createElement(l.DialogClose,{asChild:!0},React.createElement(l.Button,{variant:"ghost",color:"base",size:"icon",className:"bw-shadow-none"},React.createElement(E.X,{strokeWidth:"2",className:"bw-h-3 bw-w-3"}))):null}var j=wp.i18n;function at({prevButton:t,submitButton:e}){const o=y().process;return t||e||!t&&o.can.prevAct?React.createElement("div",{className:"bw-relative bw-z-10 bw-mt-auto bw-flex bw-items-center bw-justify-end bw-border-0 bw-border-t bw-border-solid bw-p-3 bw-px-4"},t,!t&&o.can.prevAct&&React.createElement(l.Button,{key:"default-prev-node",className:"bw-me-auto bw-pl-0",variant:"link",onClick:()=>o.mutate.prevAct()},React.createElement(E.ArrowLeft,null),j.__("Back","bookster")),e):null}function H(){const t=h().formLayout,{actIndex:e,stepIndex:o}=F(c=>c.process.current),n=y().process,{summaryCost:a,summarySelect:i}=V(),r=t==="mobile"&&!(e===0&&o===0)&&n.computed.phase!=="complete";return React.createElement(l.Dialog,null,r&&React.createElement(l.DialogTrigger,{asChild:!0},React.createElement(l.Button,{variant:"ghost",size:"icon"},React.createElement(E.Receipt,null))),React.createElement(l.DialogPortal,{container:l.portalContainer},React.createElement(l.DialogOverlay,{className:"bw-z-[100001]"}),React.createElement(l.DialogContent,{className:"bw-z-[100002] bw-text-gray-800",onInteractOutside:void 0,onPointerDownOutside:void 0},React.createElement(l.DialogCloseIcon,{className:"bw-top-4"}),React.createElement(l.DialogHeader,{className:"bw-py-3"},React.createElement(l.DialogTitle,{className:"bw-text-base bw-font-medium bw-text-gray-500"},j.__("Summary","bookster"))),React.createElement(l.DialogBody,null,React.createElement(l.Slot,{key:i.key,className:"bw-pb-4"},i.node),React.createElement(l.Slot,{key:a.key,className:"bw-mt-auto bw-p-0 bw-pt-4"},a.node)))))}function rt(){const t=h().formLayout,e=y().process;return t==="mobile"?React.createElement("div",{className:"bw-px-4 bw-text-xl bw-font-bold"},React.createElement("div",{className:"bw-flex bw-items-center bw-gap-2 bw-border-0 bw-border-b bw-border-solid bw-py-3"},React.createElement("p",{className:"bw-mb-0 bw-flex-grow bw-font-heading bw-text-lg bw-font-semibold bw-text-primary"},e.computed.title),React.createElement(H,null),React.createElement(M,null))):null}const Z=m.createContext(null);function it(){const t=m.useContext(Z);if(!t)throw new Error("PreviewConfigContext.Provider is missing!");return t}const L=m.createContext(void 0),T=(t,e)=>{for(const o of t)for(const n of o.services||[])if(n.service_id===e)return n;return null};function _(){const t=m.useContext(L);if(!t)throw new Error("ApptFormContext.Provider is missing!");return t}var B=booksterModules.antd,s=booksterModules.decimal,p=booksterModules.hooks;function v(t,e,o){const[n,a]=t;switch(n){case"fixed":return s.Decimal.fromNumber(a);case"rate":return e.pipe([{operator:"multiply",operand:s.Decimal.fromNumber(a,2)},{operator:"divide",operand:s.Decimal.fromNumber(100)}]);case"compoundRate":return o.pipe([{operator:"multiply",operand:s.Decimal.fromNumber(a,2)},{operator:"divide",operand:s.Decimal.fromNumber(100)}]);default:throw new Error(`Invalid formula key: ${n}`)}}function q(t){return{items:t.items.map(e=>({id:e.id,title:e.title,formula:e.formula,amount:s.Decimal.fromNumber(e.amount)})),subtotal:s.Decimal.fromNumber(t.subtotal)}}function z(t){return{items:t.items.map(e=>({id:e.id,title:e.title,formula:e.formula,amount:e.amount.numberValue})),subtotal:t.subtotal.numberValue}}function K(t,e){let o=e;const n=[];return t.items.forEach(a=>{const i=v(a.formula,e,o),u=o.add(i);u.isNegative()?(n.push({...a,amount:o.multiply(-1)}),o=s.ZERO):(n.push({...a,amount:i}),o=u)}),{items:n,subtotal:o}}function U(t){return{items:t.items.map(e=>({id:e.id,title:e.title,quantity:e.quantity,unitPrice:s.Decimal.fromNumber(e.unitPrice),amount:s.Decimal.fromNumber(e.amount)})),subtotal:s.Decimal.fromNumber(t.subtotal)}}function W(t){return{items:t.items.map(e=>({id:e.id,title:e.title,quantity:e.quantity,unitPrice:e.unitPrice.numberValue,amount:e.amount.numberValue})),subtotal:t.subtotal.numberValue}}function G(t){return t.reduce((e,o)=>e.add(o.amount),s.Decimal.fromNumber(0))}function Q(t){const e=t.items.map(o=>({...o,amount:o.unitPrice.multiply(o.quantity)}));return{items:e,subtotal:G(e)}}function k(t){return{id:d.genUniqueId(),title:t.name,quantity:1,unitPrice:s.Decimal.fromString(t.price),amount:s.ZERO}}function X(t){return{items:t.items.map(e=>({id:e.id,title:e.title,formula:e.formula,amount:s.Decimal.fromNumber(e.amount)})),total:s.Decimal.fromNumber(t.total)}}function $(t){return{items:t.items.map(e=>({id:e.id,title:e.title,formula:e.formula,amount:e.amount.numberValue})),total:t.total.numberValue}}function J(t,e){let o=e;const n=[];return t.items.forEach(a=>{const i=v(a.formula,e,o),u=o.add(i);u.isNegative()?(n.push({...a,amount:o.multiply(-1)}),o=s.ZERO):(n.push({...a,amount:i}),o=u)}),{items:n,total:o}}function ct(t){return{booking:U(t.booking),adjustment:q(t.adjustment),tax:X(t.tax)}}function ut(t){const e=w(t),o=Y(e);return{booking:W(o.booking),adjustment:z(o.adjustment),tax:$(o.tax)}}function Y(t){return{...t,adjustment:{items:t.adjustment.items.filter(e=>e.amount.isZero()===!1),subtotal:t.adjustment.subtotal},tax:{items:t.tax.items.filter(e=>e.amount.isZero()===!1),total:t.tax.total}}}function w(t){const e=Q(t.booking),o=K(t.adjustment,e.subtotal),n=J(t.tax,o.subtotal);return{booking:e,adjustment:o,tax:n}}function D(t,e){return e.isZero()&&t.paid_amount.isZero()?{payment_status:"complete",paid_amount:t.paid_amount}:t.payment_status==="unpaid"||t.payment_status==="refunded"?{payment_status:t.payment_status,paid_amount:s.ZERO}:t.payment_status==="complete"?{payment_status:"complete",paid_amount:e}:t}function lt(t,e){return t.payment_status==="incomplete"&&t.paid_amount.equals(e)?{payment_status:"complete",paid_amount:t.paid_amount}:D(t,e)}function tt(){const{apptForm:t,initialValues:e}=_(),o=B.Form.useWatch(["service_id"],t),n=o!==void 0?o:e.service_id,{data:a}=d.useAllServicesQuery();if(n===null||a===void 0)return{selectedService:null,hasMultipleBookings:!1};const i=T(a,n);if(!i)throw new Error("Invalid service id");const u=p.booksterHooks.applyFilters(p.ADDON_GROUP_HOOKS_NAME.service.hasMultipleBookings,!1,i);return{selectedService:i,hasMultipleBookings:u}}function mt(t){const e=B.Form.useFormInstance(),{apptForm:o}=_(),{selectedService:n}=tt();function a(r){const c={paid_amount:e.getFieldValue([...t,"paid_amount"]),payment_status:e.getFieldValue([...t,"payment_status"])},{paid_amount:b,payment_status:f}=D(c,r);e.setFieldValue([...t,"paid_amount"],b),e.setFieldValue([...t,"payment_status"],f)}function i(){if(!n)return;const r=o.getFieldsValue(),c=e.getFieldValue([...t]),b=p.booksterHooks.applyFilters(p.HOOK_NAMES.adminApptForm.detailsReloadBookingValue,{items:[k(n)],subtotal:s.ZERO},r,c),f={...c.booking_details,booking:b},g=w(f);e.setFieldValue([...t,"booking_details","booking"],g.booking),e.setFieldValue([...t,"booking_details","adjustment"],g.adjustment),e.setFieldValue([...t,"booking_details","tax"],g.tax),a(g.tax.total)}function u(){if(!n)return;const r=o.getFieldsValue(),c=e.getFieldValue([...t]),b=bt(),f=p.booksterHooks.applyFilters(p.HOOK_NAMES.adminApptForm.detailsReloadBookingValue,{items:[k(n)],subtotal:s.ZERO},r,c),g={...c.booking_details,booking:f,tax:b.booking_details.tax},x=w(g);e.setFieldValue([...t,"booking_details","booking"],x.booking),e.setFieldValue([...t,"booking_details","adjustment"],x.adjustment),e.setFieldValue([...t,"booking_details","tax"],x.tax),a(x.tax.total)}return{recalculatedPayment:a,recalculateBookingDetails:i,reloadRecalculateBookingDetails:u}}const dt={booking:{items:[],subtotal:s.ZERO},adjustment:{items:[],subtotal:s.ZERO},tax:{items:[],total:s.ZERO}},pt={customer_id:null,booking_details:dt,paid_amount:s.ZERO,payment_status:"incomplete"};function bt(){return p.booksterHooks.applyFilters(p.HOOK_NAMES.adminApptForm.initBookingValues,pt,void 0)}function ft(){const{apptForm:t,initialValues:e}=_(),o=B.Form.useWatch(["bookings"],t);return o!==void 0?o:e.bookings}function gt(t,e,o,n,a){const i={items:[k(t)],subtotal:s.ZERO},u={items:[],subtotal:s.ZERO},r={items:[],total:s.ZERO},c={booking:i,adjustment:u,tax:r};return p.booksterHooks.applyFilters(p.HOOK_NAMES.bookingForm.makeBlueprintBooking,c,t,e,o,n,a)}function kt(t,e,o=10){p.booksterHooks.addFilter(p.HOOK_NAMES.bookingForm.makeBlueprintBooking,t,e,o)}function wt(t,e){const o=s.Decimal.fromString(e),n={items:[k(t)],subtotal:s.ZERO},a={items:[],subtotal:s.ZERO},i={items:[],total:s.ZERO},r=w({booking:n,adjustment:a,tax:i});if(o.equals(r.tax.total))return r;{const c=o.subtract(r.tax.total);return r.adjustment.items.push({id:d.genUniqueId(),title:"Adjustment",formula:["fixed",c.numberValue],amount:c}),r}}const C=Object.freeze(Object.defineProperty({__proto__:null,ACT_NAME:et,ApptFormContext:L,BookingConfigContext:R,BookingLayoutContext:P,BookingLogicContext:I,BookingPartsContext:N,BookingStoreContext:A,CloseDialogButton:M,Helper:d.bookHelper,MainFooter:at,MainHeader:rt,PreviewConfigContext:Z,SummaryDialog:H,applyFormValuesIntoAgentDayOff:d.applyFormValuesIntoAgentDayOff,applyFormValuesIntoHolidaySettings:d.applyFormValuesIntoHolidaySettings,beginMutateNextAct:st,beginMutatePrevAct:nt,calculateAdjustment:K,calculateBooking:Q,calculateDetails:w,calculateIsDayOff:d.calculateIsDayOff,calculatePayment:D,calculateTax:J,checkSiteSettingsHoliday:d.checkSiteSettingsHoliday,checkSpecificAgentDayOff:d.checkSpecificAgentDayOff,cleanDetails:Y,createBookingStore:ot,extendBlueprintBooking:kt,findServiceById:T,isWeeklyDayOff:d.isWeeklyDayOff,makeBasicItem:k,makeBlueprintBooking:gt,makeBlueprintBookingVer1_0:wt,parseAdjustment:q,parseBooking:U,parseDetails:ct,parseTax:X,preparePayment:lt,runFormula:v,serializeAdjustment:z,serializeBooking:W,serializeDetails:ut,serializeTax:$,sumBooking:G,useApptFormLogic:_,useBookingConfig:S,useBookingLayout:h,useBookingLogic:y,useBookingParts:V,useBookingRecalculate:mt,useBookingState:F,useBookingStore:O,useBookingsValue:ft,usePreviewConfig:it,useSelectedService:tt},Symbol.toStringTag,{value:"Module"}));window.booksterModules?window.booksterModules.booking=C:window.booksterModules={booking:C};
